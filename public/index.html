<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DAILY DIGEST</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      
      :root {
        --bg: #ffffff;
        --bg-secondary: #f8f9fa;
        --text: #1a1a1a;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --border: #e5e7eb;
        --border-light: #f3f4f6;
        --primary: #000000;
        --accent: #6366f1;
        --accent-light: #e0e7ff;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
      }

      body.dark {
        --bg: #020617;
        --bg-secondary: #020617;
        --text: #e5e7eb;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --border: #1f2937;
        --border-light: #111827;
        --primary: #f9fafb;
        --accent: #6366f1;
        --accent-light: rgba(129, 140, 248, 0.18);
        --success: #22c55e;
        --warning: #facc15;
        --danger: #f97373;
        --card-shadow: 0 22px 60px rgba(15, 23, 42, 0.95);
      }

      body.dark .lang-toggle {
        background: #020617;
        border-color: #1f2937;
        box-shadow: 0 10px 35px rgba(15, 23, 42, 0.9);
      }

      body.dark .lang-btn {
        color: #9ca3af;
      }

      body.dark .account-btn {
        background: #020617;
        border-color: #1f2937;
        color: #e5e7eb;
      }

      .theme-btn {
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.18s ease;
        width: auto;
      }

      .theme-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
      }


      body.dark .lang-btn.active {
        background: #111827;
        color: #e5e7eb;
      }

      body.dark .app-container {
        background:
          radial-gradient(circle at top, rgba(129, 140, 248, 0.18), transparent 55%),
          radial-gradient(circle at bottom, rgba(56, 189, 248, 0.12), transparent 55%),
          #020617;
      }

      body.dark .card {
        background: #020617;
        border-color: #1f2937;
      }

      body.dark .card-header h2,
      body.dark .card-header p {
        color: #e5e7eb;
      }

      body.dark .input {
        background: #020617;
        border-color: #1f2937;
        color: #e5e7eb;
      }

      body.dark .input::placeholder {
        color: #6b7280;
      }

      body.dark .btn-primary {
        background: #6366f1;
        color: #f9fafb;
      }

      body.dark .btn-primary:hover {
        background: #4f46e5;
      }

      body.dark button[type="submit"] {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #1f2937;
      }

      body.dark button[type="submit"]:hover {
        background: #1f2937;
      }

      body.dark .btn-outline {
        border-color: #374151;
        color: #e5e7eb;
      }

      body.dark .btn-outline:hover {
        background: #111827;
      }

      body.dark .badge-keyword {
        background: rgba(55, 65, 81, 0.7);
        color: #e5e7eb;
      }

      body.dark .news-list li {
        border-color: #111827;
      }

      body.dark .news-link {
        color: #e5e7eb;
      }

      body.dark .news-link:hover {
        color: #a5b4fc;
      }

      body.dark .metric-label {
        color: #9ca3af;
      }

      body.dark .tooltip-badge {
        background: rgba(31, 41, 55, 0.95);
        color: #e5e7eb;
        border-color: #374151;
      }


      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
        font-weight: 400;
        -webkit-font-smoothing: antialiased;
      }

      .top-actions {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .lang-toggle {
        display: flex;
        gap: 0.35rem;
        background: white;
        padding: 0.3rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .account-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: white;
        font-weight: 600;
        color: var(--text);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
        width: auto;
      }

      .account-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
      }

      .account-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: var(--accent);
        color: white;
        font-size: 0.8rem;
        font-weight: 700;
      }

      .account-menu-wrapper {
        position: relative;
      }

      .account-menu {
        position: absolute;
        right: 0;
        top: calc(100% + 0.6rem);
        min-width: 260px;
        padding: 1rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
        color: #0f172a;
        z-index: 200;
      }

      body.dark .account-menu {
        background: #0b0f19;
        border-color: #1f2937;
        color: #f9fafb;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
      }

      .account-menu-header {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        margin-bottom: 0.75rem;
      }

      .account-menu-name {
        font-size: 1.05rem;
        font-weight: 700;
      }

      .account-menu-email {
        color: rgba(15, 23, 42, 0.6);
        font-size: 0.85rem;
        word-break: break-all;
      }

      body.dark .account-menu-email {
        color: rgba(226, 232, 240, 0.8);
      }

      .account-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.65rem;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.25);
        color: #c7d2fe;
        font-size: 0.75rem;
        font-weight: 600;
        width: fit-content;
      }

      .account-menu-item {
        width: 100%;
        background: transparent;
        border: none;
        color: #0f172a;
        text-align: left;
        padding: 0.55rem 0.4rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .account-menu-item:hover {
        background: rgba(15, 23, 42, 0.06);
      }

      body.dark .account-menu-item {
        color: #e5e7eb;
      }

      body.dark .account-menu-item:hover {
        background: rgba(148, 163, 184, 0.15);
      }

      .account-menu-footer {
        border-top: 1px solid rgba(148, 163, 184, 0.2);
        margin-top: 0.75rem;
        padding-top: 0.75rem;
      }

      .account-menu-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        margin-top: 0.6rem;
        padding-top: 0.6rem;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
      }

      .account-menu .lang-toggle {
        background: #ffffff;
        border-color: #e2e8f0;
        box-shadow: none;
      }

      .account-menu .lang-btn.active {
        background: #0f172a;
        color: #ffffff;
      }

      body.dark .account-menu .lang-toggle {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(148, 163, 184, 0.2);
      }

      body.dark .account-menu .lang-btn.active {
        background: #f9fafb;
        color: #0b0f19;
      }

      .lang-btn {
        padding: 0.35rem 0.75rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.8rem;
        transition: all 0.2s;
        width: auto;
      }

      .lang-btn.active {
        background: var(--primary);
        color: white;
      }

      .lang-btn:hover:not(.active) {
        background: var(--bg-secondary);
        color: var(--text);
      }

      header {
        text-align: center;
        padding: 3rem 1.5rem 2rem;
        background: var(--bg);
      }

      header h1 {
        font-size: clamp(2.5rem, 6vw, 4rem);
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text);
        letter-spacing: -0.02em;
      }

      header p {
        font-size: 1.25rem;
        color: var(--text-secondary);
        font-weight: 400;
        max-width: 600px;
        margin: 0 auto;
      }

      main {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1.5rem 2rem;
      }

      .card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.75rem;
        color: var(--text);
        font-size: 0.85rem;
      }

      input, select, textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 1rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
        font-family: inherit;
        font-weight: 400;
      }

      textarea {
        min-height: 80px;
        resize: vertical;
        line-height: 1.6;
      }

      .address-input-wrapper {
        display: flex;
        gap: 0.75rem;
        align-items: stretch;
        margin-bottom: 1rem;
        flex-direction: row;
      }

      .address-input-wrapper textarea {
        flex: 1;
        margin-bottom: 0;
        min-height: auto;
        height: auto;
        line-height: 1.5;
        padding: 0.75rem 1rem;
        resize: none;
        overflow-y: auto;
        order: 2;
        box-sizing: border-box;
      }

      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
      }

      input::placeholder, textarea::placeholder {
        color: var(--text-muted);
      }

      button {
        width: 100%;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        background: var(--primary);
        color: white;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }

      button:hover {
        background: #333;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      button:active {
        transform: translateY(0);
      }

      .btn-outline {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
      }

      .btn-outline:hover {
        background: var(--bg-secondary);
        border-color: var(--text);
      }

      .auth-card .card-header {
        margin-bottom: 1rem;
      }

      .auth-status {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 1rem;
      }

      .auth-actions,
      .form-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .auth-actions button,
      .form-actions button {
        width: auto;
        padding: 0.65rem 1.2rem;
        font-size: 0.85rem;
      }

      .pref-status {
        margin-top: 0.75rem;
        color: var(--text-secondary);
        font-size: 0.8rem;
      }

      .auth-page {
        position: fixed;
        inset: 0;
        background:
          radial-gradient(circle at top, rgba(99, 102, 241, 0.12), transparent 55%),
          radial-gradient(circle at bottom, rgba(14, 165, 233, 0.1), transparent 55%),
          #0b1120;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 2rem 1.5rem;
        z-index: 300;
      }

      .auth-page-card {
        width: min(620px, 100%);
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 2rem;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
      }

      .auth-page-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .auth-page-footer {
        display: flex;
        justify-content: flex-end;
        margin-top: 1.25rem;
      }

      .auth-close {
        padding: 0.2rem 0.15rem;
        font-size: 0.85rem;
      }

      .btn-disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .takeaway-section {
        background: var(--bg-secondary);
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        border: 1px solid var(--border);
      }

      .takeaway-section h2 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        font-weight: 600;
        color: var(--text);
      }

      .things-to-watch {
        margin-bottom: 1.5rem;
      }

      .things-to-watch h3 {
        font-size: 1rem;
        margin-bottom: 1rem;
        color: var(--text);
        font-weight: 500;
      }

      .things-to-watch ul {
        list-style: none;
        padding-left: 0;
      }

      .things-to-watch li {
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        background: white;
        border-radius: 10px;
        border-left: 3px solid var(--accent);
        font-size: 0.85rem;
        line-height: 1.6;
      }

      .takeaway-box {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .takeaway-box h3 {
        font-size: 1rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: var(--text);
      }

      .takeaway-box p {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--text);
      }

      .ai-disabled {
        background: var(--accent-light);
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 2rem;
        font-size: 0.85rem;
      }

      .news-list {
        display: grid;
        gap: 0.75rem;
      }

      .news-item {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .news-item:hover {
        background: var(--bg-secondary);
        border-color: var(--primary);
        transform: translateX(2px);
      }

      .news-item h3 {
        font-size: 0.8rem;
        font-weight: 500;
        margin: 0;
        flex: 1;
        line-height: 1.5;
        color: var(--text);
      }

      .news-item a {
        color: var(--text);
        text-decoration: none;
        transition: color 0.2s;
      }

      .news-item a:hover {
        color: var(--accent);
      }

      .news-item .link-icon {
        color: var(--text-muted);
        font-size: 1rem;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .news-item:hover .link-icon {
        color: var(--primary);
        transform: translateX(2px);
      }

      .status {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
        font-size: 1rem;
      }

      .error {
        color: var(--error);
        background: #fef2f2;
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid #fecaca;
        text-align: center;
        font-size: 0.85rem;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
      }

      .loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
      }

      .address-input-group {
        display: grid;
        gap: 1rem;
      }

      .address-input-group textarea {
        margin-bottom: 0;
      }

      .helper-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: -0.5rem;
        margin-bottom: 1rem;
      }

      .location-detect-btn {
        padding: 0.75rem 0.875rem;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        background: var(--bg-secondary);
        color: var(--text);
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s;
        font-family: inherit;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        white-space: nowrap;
        flex-shrink: 0;
        align-self: stretch;
        order: 1;
        min-width: auto;
        width: auto;
        max-width: fit-content;
        box-sizing: border-box;
        height: 100%;
      }
      
      button.location-detect-btn {
        width: auto !important;
      }

      .location-detect-btn:hover {
        background: var(--border);
        border-color: var(--primary);
      }

      .location-detect-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .top-actions {
          top: 1rem;
          right: 1rem;
          flex-direction: column;
          align-items: flex-end;
        }

        header {
          padding: 4rem 1rem 3rem;
        }

        .card {
          padding: 1.5rem;
        }

        .news-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .news-item h3 {
          margin-bottom: 0.5rem;
        }

        .account-layout {
          grid-template-columns: 1fr;
        }

        .account-menu {
          min-width: 220px;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-actions">
      <div class="account-menu-wrapper">
        <button class="account-btn" id="accountBtn" type="button">
          <span class="account-avatar" id="accountAvatarBtn">U</span>
          <span id="accountBtnLabel" data-i18n="nav-login">Log in</span>
        </button>
        <div class="account-menu" id="accountMenu" hidden>
          <div class="account-menu-header">
            <div class="account-menu-name" id="menuUsername" data-i18n="menu-guest-title">Guest</div>
            <div class="account-menu-email" id="menuEmail" data-i18n="menu-guest-subtitle">Sign in to manage your account.</div>
          </div>
          <div>
            <button class="account-menu-item" id="menuHome" type="button" data-i18n="menu-home">Home</button>
            <button class="account-menu-item" id="menuNotifications" type="button" data-i18n="menu-notifications">Notifications</button>
            <button class="account-menu-item" id="menuAccountSettings" type="button" data-i18n="menu-settings">Settings</button>
            <button class="account-menu-item" id="menuSavedPreferences" type="button" data-i18n="menu-saved-preferences">Saved Preferences</button>
            <button class="account-menu-item" id="menuLogin" type="button" data-i18n="menu-login">Log in</button>
            <div class="account-menu-controls">
              <div class="lang-toggle">
                <button class="lang-btn active" data-lang="en">English</button>
                <button class="lang-btn" data-lang="zh">‰∏≠Êñá</button>
              </div>
              <button class="theme-btn" id="themeToggle" aria-label="Toggle dark mode">üåô</button>
            </div>
          </div>
          <div class="account-menu-footer">
            <button class="account-menu-item" id="menuLogout" type="button" data-i18n="auth-logout">Log out</button>
          </div>
        </div>
      </div>
    </div>

      <section class="auth-page" id="authPage" style="display: none;">
        <div class="auth-page-card">
          <div class="auth-page-header">
            <div>
              <h2 data-i18n="auth-title">Account</h2>
              <p data-i18n="auth-subtitle">Sign in to save preferences and history.</p>
            </div>
          </div>
          <div class="auth-status" id="authStatus" data-i18n="auth-status-signed-out">Not signed in.</div>
          <form id="authForm" class="auth-form">
          <div>
            <label for="authEmail" data-i18n="auth-email">Email</label>
            <input id="authEmail" name="authEmail" type="email" data-i18n-placeholder="auth-email-placeholder" placeholder="name@example.com" required />
          </div>
          <div>
            <label for="authPassword" data-i18n="auth-password">Password</label>
            <input id="authPassword" name="authPassword" type="password" data-i18n-placeholder="auth-password-placeholder" placeholder="At least 8 characters" minlength="8" required />
          </div>
          <div class="auth-actions">
            <button type="button" data-auth-action="login" data-i18n="auth-login">Log in</button>
            <button type="button" class="btn-outline" data-auth-action="signup" data-i18n="auth-signup">Sign up</button>
          </div>
        </form>
        <div class="auth-page-footer">
          <button type="button" class="btn-outline auth-close" id="authCloseBtn" data-i18n="auth-close">Back</button>
        </div>
      </div>
    </section>

    <div id="mainContent">
      <header>
        <h1 data-i18n="title">üì∞ Daily Digest</h1>
        <p data-i18n="subtitle">Get your daily news summary in seconds</p>
      </header>

      <main>
      <section class="card">
        <form id="interestForm">
          <div>
            <label for="topic" data-i18n="topic-label">What news topics interest you?</label>
            <input
              id="topic"
              name="topic"
              data-i18n-placeholder="topic-placeholder"
              placeholder="e.g., Finance, Tech, Lifestyle, AI"
              required
            />
          </div>

          <div>
            <label for="presetSource">Source (optional)</label>
            <select id="presetSource" name="presetSource">
              <option value="">üåê Google News (default)</option>
              <option value="bbc_world">BBC News - World</option>
              <option value="cnn_world">CNN - World</option>
              <option value="cnn_international">CNN - International Edition</option>
              <option value="nyt_world">NYT - World News</option>
              <option value="nyt_top">NYT - Top Stories</option>
              <option value="guardian_world">The Guardian - World</option>
              <option value="wapo_world">Washington Post - World</option>
              <option value="wsj_world">WSJ - World News</option>
              <option value="latimes_world">LA Times - World &amp; Nation</option>
              <option value="cnbc_international">CNBC International</option>
              <option value="cnbc_us">CNBC - US Top News</option>
              <option value="yahoo_news">Yahoo News - Latest</option>
              <option value="yahoo_mostviewed">Yahoo News - Most viewed</option>
              <option value="huffpost_world">HuffPost - World News</option>
              <option value="fox_news">FOX News - Latest</option>
              <option value="toi_world">Times of India - World</option>
              <option value="ndtv_world">NDTV - World News</option>
              <option value="reddit_worldnews">Reddit - r/worldnews</option>
              <option value="google_top">Google News - Top stories</option>
              <option value="politico_playbook">Politico - Playbook</option>
            </select>
            <p class="helper-text">
              Leave as default to use Google News by topic &amp; region, or choose a specific news site.
            </p>
          </div>

          <div>
            <label for="address" data-i18n="address-label">Location (City, State/Province, Country)</label>
            <div class="address-input-wrapper">
              <button type="button" class="location-detect-btn" id="detectLocation" data-i18n="detect-location">
                üìç Detect My Location
              </button>
              <textarea
                id="address"
                name="address"
                data-i18n-placeholder="address-placeholder"
                placeholder="e.g., New York, USA, Taiwan, or London"
                rows="1"
                required
              ></textarea>
            </div>
            <p class="helper-text" data-i18n="address-helper">Enter your location or click to detect automatically</p>
          </div>
          <div class="form-actions">
            <button type="submit" data-i18n="submit-btn">Generate Daily Digest</button>
            <button type="button" class="btn-outline" id="savePreferences" data-i18n="save-preferences">Save Preferences</button>
          </div>
          <div class="pref-status" id="prefStatus" data-i18n="pref-status-idle">Save your preferences after you sign in.</div>
        </form>
        <p class="status" id="helper" data-i18n="helper-text">Fetching latest news from the past 24 hours...</p>
      </section>

      <div id="aiDisabledNotice" class="ai-disabled" style="display: none;" data-i18n="ai-disabled">
        AI summarization is currently unavailable. News articles are displayed without AI-generated summaries.
      </div>

      <section id="takeawaySection" class="card takeaway-section" style="display: none;">
        <h2 data-i18n="takeaway-title">Today's Highlights</h2>
        <div class="things-to-watch" id="thingsToWatch"></div>
        <div class="takeaway-box" id="takeawayBox"></div>
      </section>

      <section class="card">
        <div id="status" class="status" data-i18n="status-default">Please submit the form to get your daily digest.</div>
        <div class="news-list" id="newsList"></div>
      </section>
      </main>
    </div>

    <script>
      // Â§öË™ûË®ÄÊîØÊè¥ - ÈªòË™çËã±ÊñáÂÑ™ÂÖà
      let currentLang = 'en';

      const translations = {
        zh: {
          title: "üì∞ ÊØèÊó•ÊëòË¶Å",
          subtitle: "ÂπæÁßíÂÖßÁç≤ÂèñÊÇ®ÁöÑÂÄãÊÄßÂåñÊñ∞ËÅûÊëòË¶Å",
          "nav-login": "ÁôªÂÖ•",
          "menu-guest-title": "Ë®™ÂÆ¢",
          "menu-guest-subtitle": "ÁôªÂÖ•‰ª•ÁÆ°ÁêÜ‰Ω†ÁöÑÂ∏≥Êà∂„ÄÇ",
          "menu-home": "È¶ñÈ†Å",
          "menu-login": "ÁôªÂÖ•",
          "menu-settings": "Ë®≠ÂÆö",
          "menu-saved-preferences": "Â∑≤ÂÑ≤Â≠òÂÅèÂ•Ω",
          "menu-notifications": "ÈÄöÁü•",
          "menu-theme-toggle": "ÂàáÊèõÊ∑±Ëâ≤Ê®°Âºè",
          "auth-title": "Â∏≥Êà∂",
          "auth-subtitle": "ÁôªÂÖ•ÂæåÂèØ‰øùÂ≠òÂÅèÂ•ΩËàáÊ≠∑Âè≤Á¥ÄÈåÑ„ÄÇ",
          "auth-email": "Email",
          "auth-email-placeholder": "name@example.com",
          "auth-password": "ÂØÜÁ¢º",
          "auth-password-placeholder": "Ëá≥Â∞ë 8 ÂÄãÂ≠óÂÖÉ",
          "auth-login": "ÁôªÂÖ•",
          "auth-signup": "Ë®ªÂÜä",
          "auth-logout": "ÁôªÂá∫",
          "auth-close": "ËøîÂõû",
          "auth-status-signed-out": "Â∞öÊú™ÁôªÂÖ•„ÄÇ",
          "auth-status-signed-in": "Â∑≤ÁôªÂÖ•Ôºö{email}",
          "auth-status-error": "ÁôªÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Â∏≥ËôüÂØÜÁ¢º„ÄÇ",
          "auth-status-logged-in": "‰Ω†Â∑≤ÁôªÂÖ•„ÄÇ",
          "auth-error-email-exists": "Ê≠§ Email Â∑≤Ë®ªÂÜä„ÄÇ",
          "auth-error-password-short": "ÂØÜÁ¢ºËá≥Â∞ë 8 ÂÄãÂ≠óÂÖÉ„ÄÇ",
          "auth-error-missing": "Ë´ãËº∏ÂÖ• Email ËàáÂØÜÁ¢º„ÄÇ",
          "save-preferences": "ÂÑ≤Â≠òÂÅèÂ•Ω",
          "pref-status-idle": "ÁôªÂÖ•ÂæåÂèØÂÑ≤Â≠òÂÅèÂ•Ω„ÄÇ",
          "pref-status-saved": "ÂÅèÂ•ΩÂ∑≤ÂÑ≤Â≠ò„ÄÇ",
          "pref-status-error": "ÂÅèÂ•ΩÂÑ≤Â≠òÂ§±Êïó„ÄÇ",
          "pref-status-login-required": "Ë´ãÂÖàÁôªÂÖ•ÂÜçÂÑ≤Â≠òÂÅèÂ•Ω„ÄÇ",
          "account-title": "Â∏≥Êà∂Ë®≠ÂÆö",
          "account-subtitle": "ÁÆ°ÁêÜ‰Ω†ÁöÑË≥áÊñôËàáÂØÜÁ¢º„ÄÇ",
          "account-logged-in": "‰Ω†Â∑≤ÁôªÂÖ•„ÄÇ",
          "account-profile-title": "ÂÄã‰∫∫Ë≥áÊñô",
          "account-username": "‰ΩøÁî®ËÄÖÂêçÁ®±",
          "account-update-profile": "Êõ¥Êñ∞Ë≥áÊñô",
          "account-profile-idle": "ÂèØÈö®ÊôÇÊõ¥Êñ∞‰ΩøÁî®ËÄÖÂêçÁ®±„ÄÇ",
          "account-profile-success": "‰ΩøÁî®ËÄÖÂêçÁ®±Â∑≤Êõ¥Êñ∞„ÄÇ",
          "account-profile-error": "Êõ¥Êñ∞‰ΩøÁî®ËÄÖÂêçÁ®±Â§±Êïó„ÄÇ",
          "saved-preferences-title": "Â∑≤ÂÑ≤Â≠òÂÅèÂ•Ω",
          "account-password-title": "ËÆäÊõ¥ÂØÜÁ¢º",
          "account-current-password": "ÁõÆÂâçÂØÜÁ¢º",
          "account-new-password": "Êñ∞ÂØÜÁ¢º",
          "account-confirm-password": "Á¢∫Ë™çÊñ∞ÂØÜÁ¢º",
          "account-update-password": "Êõ¥Êñ∞ÂØÜÁ¢º",
          "account-password-idle": "ÂèØÈö®ÊôÇÊõ¥Êñ∞ÂØÜÁ¢º„ÄÇ",
          "account-password-mismatch": "Êñ∞ÂØÜÁ¢º‰∏ç‰∏ÄËá¥„ÄÇ",
          "account-password-success": "ÂØÜÁ¢ºÂ∑≤Êõ¥Êñ∞„ÄÇ",
          "account-password-error": "Êõ¥Êñ∞ÂØÜÁ¢ºÂ§±Êïó„ÄÇ",
          "topic-label": "ÊÇ®Â∞çÂì™‰∫õÊñ∞ËÅû‰∏ªÈ°åÊÑüËààË∂£Ôºü",
          "topic-placeholder": "‰æãÂ¶ÇÔºöË≤°Á∂ì„ÄÅÁßëÊäÄ„ÄÅÁîüÊ¥ª„ÄÅAI",
          "address-label": "‰ΩçÁΩÆÔºàÂüéÂ∏Ç„ÄÅÂ∑û/ÁúÅ„ÄÅÂúãÂÆ∂Ôºâ",
          "address-placeholder": "‰æãÂ¶ÇÔºöÁ¥êÁ¥ÑÔºåÁæéÂúãÔºåÂè∞ÁÅ£ÊàñÂÄ´Êï¶",
          "address-helper": "Ë´ãËº∏ÂÖ•‰ΩçÁΩÆÊàñÈªûÊìäËá™ÂãïÂÅµÊ∏¨",
          "detect-location": "üìç ÂÅµÊ∏¨ÊàëÁöÑ‰ΩçÁΩÆ",
          "detecting-location": "Ê≠£Âú®ÂÅµÊ∏¨‰ΩçÁΩÆ...",
          "location-error": "ÁÑ°Ê≥ïÂÅµÊ∏¨‰ΩçÁΩÆÔºåË´ãÊâãÂãïËº∏ÂÖ•„ÄÇ",
          "location-success": "‰ΩçÁΩÆÂ∑≤ÂÅµÊ∏¨ÔºÅ",
          "url-label": "Ëá™Ë®Ç RSS / Êñ∞ËÅûÁ∂≤ÂùÄÔºàÈÅ∏Â°´Ôºâ",
          "url-placeholder": "‰æãÂ¶ÇÔºöhttps://example.com/rss",
          "submit-btn": "ÁîüÊàêÊØèÊó•ÊëòË¶Å",
          "helper-text": "Ê≠£Âú®Áç≤ÂèñÈÅéÂéª24Â∞èÊôÇÁöÑÊúÄÊñ∞Êñ∞ËÅû...",
          "status-default": "Ë´ãÊèê‰∫§Ë°®ÂñÆ‰ª•Áç≤ÂèñÊÇ®ÁöÑÊØèÊó•ÊëòË¶Å„ÄÇ",
          "status-loading": "Ê≠£Âú®Áç≤ÂèñÊúÄÊñ∞Êñ∞ËÅû...",
          "status-no-news": "ÁõÆÂâçÊ≤íÊúâÁ¨¶ÂêàÁöÑÊñ∞ËÅûÔºåÊèõÂÄãÈóúÈçµÂ≠óË©¶Ë©¶Ôºü",
          "status-count": "ÊâæÂà∞ {count} ÂâáÁõ∏ÈóúÊñ∞ËÅû",
          "takeaway-title": "‰ªäÊó•ÈáçÈªû",
          "things-to-watch": "‰ªäÂ§©ÈúÄË¶ÅÊ≥®ÊÑèÁöÑ‰∫ãÊÉÖ",
          "takeaway": "Take Away",
          "error-fetch": "ÁÑ°Ê≥ïÂèñÂæóÊñ∞ËÅû",
          "ai-disabled": "AI ÊëòË¶ÅÂäüËÉΩÁõÆÂâç‰∏çÂèØÁî®„ÄÇÊñ∞ËÅûÊñáÁ´†Â∞áÂú®Ê≤íÊúâ AI ÁîüÊàêÊëòË¶ÅÁöÑÊÉÖÊ≥Å‰∏ãÈ°ØÁ§∫„ÄÇ"
        },
        en: {
          title: "üì∞ DAILY DIGEST",
          subtitle: "Get your personalized news summary in seconds",
          "nav-login": "Log in",
          "menu-guest-title": "Guest",
          "menu-guest-subtitle": "Sign in to manage your account.",
          "menu-home": "Home",
          "menu-login": "Log in",
          "menu-settings": "Settings",
          "menu-saved-preferences": "Saved Preferences",
          "menu-notifications": "Notifications",
          "menu-theme-toggle": "Toggle Theme",
          "auth-title": "Account",
          "auth-subtitle": "Sign in to save preferences and history.",
          "auth-email": "Email",
          "auth-email-placeholder": "name@example.com",
          "auth-password": "Password",
          "auth-password-placeholder": "At least 8 characters",
          "auth-login": "Log in",
          "auth-signup": "Sign up",
          "auth-logout": "Log out",
          "auth-close": "Back",
          "auth-status-signed-out": "Not signed in.",
          "auth-status-signed-in": "Signed in as {email}",
          "auth-status-error": "Sign-in failed. Check your credentials.",
          "auth-status-logged-in": "You're logged in.",
          "auth-error-email-exists": "Email already exists.",
          "auth-error-password-short": "Password must be at least 8 characters.",
          "auth-error-missing": "Email and password are required.",
          "save-preferences": "Save Preferences",
          "pref-status-idle": "Save your preferences after you sign in.",
          "pref-status-saved": "Preferences saved.",
          "pref-status-error": "Failed to save preferences.",
          "pref-status-login-required": "Please sign in before saving preferences.",
          "account-title": "Account Settings",
          "account-subtitle": "Manage your profile and password.",
          "account-logged-in": "You're logged in.",
          "account-profile-title": "Profile",
          "account-username": "Username",
          "account-update-profile": "Update profile",
          "account-profile-idle": "Update your username anytime.",
          "account-profile-success": "Username updated.",
          "account-profile-error": "Failed to update username.",
          "saved-preferences-title": "Saved Preferences",
          "account-password-title": "Change password",
          "account-current-password": "Current password",
          "account-new-password": "New password",
          "account-confirm-password": "Confirm new password",
          "account-update-password": "Update password",
          "account-password-idle": "Update your password anytime.",
          "account-password-mismatch": "Passwords do not match.",
          "account-password-success": "Password updated.",
          "account-password-error": "Failed to update password.",
          "topic-label": "What news topics interest you?",
          "topic-placeholder": "e.g., Finance, Tech, Lifestyle, AI",
          "address-label": "Location (City, State/Province, Country)",
          "address-placeholder": "e.g., New York, USA, Taiwan, or London",
          "address-helper": "Enter your location or click to detect automatically",
          "detect-location": "üìç Detect My Location",
          "detecting-location": "Detecting location...",
          "location-error": "Unable to detect location. Please enter manually.",
          "location-success": "Location detected!",
          "url-label": "Custom RSS / News URL (Optional)",
          "url-placeholder": "e.g., https://example.com/rss",
          "submit-btn": "Generate Daily Digest",
          "helper-text": "Fetching latest news from the past 24 hours...",
          "status-default": "Please submit the form to get your daily digest.",
          "status-loading": "Fetching latest news‚Ä¶",
          "status-no-news": "No matching news found. Try different keywords?",
          "status-count": "Found {count} relevant news articles",
          "takeaway-title": "Today's Highlights",
          "things-to-watch": "Things to Watch Today",
          "takeaway": "Take Away",
          "error-fetch": "Failed to fetch news",
          "ai-disabled": "AI summarization is currently unavailable. News articles are displayed without AI-generated summaries."
        }
      };

      const TOKEN_KEY = 'dailyDigestToken';
      const LANG_KEY = 'dailyDigestLang';
      const THEME_KEY = 'dailyDigestTheme';
      let currentUser = null;

      function updateLanguage(lang) {
        currentLang = lang;
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (translations[lang][key]) {
            el.textContent = translations[lang][key];
          }
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
          const key = el.getAttribute('data-i18n-placeholder');
          if (translations[lang][key]) {
            el.placeholder = translations[lang][key];
          }
        });
        document.querySelectorAll('.lang-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.lang === lang);
        });
        renderAuthState();
        try {
          window.localStorage.setItem(LANG_KEY, lang);
        } catch (e) {
          console.error('lang save error', e);
        }
      }

      const authStatus = document.getElementById('authStatus');
      const authForm = document.getElementById('authForm');
      const authEmailInput = document.getElementById('authEmail');
      const authPasswordInput = document.getElementById('authPassword');
      const logoutBtn = document.getElementById('logoutBtn');
      const savePreferencesBtn = document.getElementById('savePreferences');
      const prefStatus = document.getElementById('prefStatus');
      const addressInput = document.getElementById('address');
      const topicInput = document.getElementById('topic');
      const accountBtn = document.getElementById('accountBtn');
      const accountBtnLabel = document.getElementById('accountBtnLabel');
      const accountAvatarBtn = document.getElementById('accountAvatarBtn');
      const accountMenu = document.getElementById('accountMenu');
      const menuHome = document.getElementById('menuHome');
      const menuLogin = document.getElementById('menuLogin');
      const menuAccountSettings = document.getElementById('menuAccountSettings');
      const menuSavedPreferences = document.getElementById('menuSavedPreferences');
      const menuNotifications = document.getElementById('menuNotifications');
      const themeToggle = document.getElementById('themeToggle');
      const menuLogout = document.getElementById('menuLogout');
      const menuUsername = document.getElementById('menuUsername');
      const menuEmail = document.getElementById('menuEmail');
      const authPage = document.getElementById('authPage');
      const authCloseBtn = document.getElementById('authCloseBtn');
      const mainContent = document.getElementById('mainContent');
      let isAuthOpen = false;
      let isMenuOpen = false;

      function getAuthToken() {
        try {
          return window.localStorage.getItem(TOKEN_KEY);
        } catch (e) {
          return null;
        }
      }

      function setAuthToken(token) {
        try {
          if (token) {
            window.localStorage.setItem(TOKEN_KEY, token);
          } else {
            window.localStorage.removeItem(TOKEN_KEY);
          }
        } catch (e) {
          console.error('auth token storage error', e);
        }
      }

      function getDisplayName(email) {
        if (!email) return '';
        const parts = email.split('@');
        return parts[0] || email;
      }

      function showAuthPage() {
        if (authPage) authPage.style.display = 'flex';
        if (mainContent) mainContent.style.display = 'none';
        isAuthOpen = true;
      }

      function hideAuthPage() {
        if (authPage) authPage.style.display = 'none';
        if (mainContent) mainContent.style.display = 'block';
        isAuthOpen = false;
      }

      function openMenu() {
        if (!accountMenu) return;
        accountMenu.hidden = false;
        isMenuOpen = true;
      }

      function closeMenu() {
        if (!accountMenu) return;
        accountMenu.hidden = true;
        isMenuOpen = false;
      }

      function getAuthErrorMessage(errorCode) {
        if (!errorCode) return translations[currentLang]['auth-status-error'];
        if (errorCode === 'email_already_exists') return translations[currentLang]['auth-error-email-exists'];
        if (errorCode === 'password_too_short') return translations[currentLang]['auth-error-password-short'];
        if (errorCode === 'email_and_password_required') return translations[currentLang]['auth-error-missing'];
        return translations[currentLang]['auth-status-error'];
      }

      function renderAuthState() {
        if (!authStatus) return;
        if (currentUser) {
          authStatus.textContent = translations[currentLang]['auth-status-logged-in'];
          if (logoutBtn) logoutBtn.style.display = 'inline-flex';
          if (authEmailInput) authEmailInput.disabled = true;
          if (authPasswordInput) authPasswordInput.disabled = true;
          if (savePreferencesBtn) {
            savePreferencesBtn.disabled = false;
            savePreferencesBtn.classList.remove('btn-disabled');
            savePreferencesBtn.title = '';
          }
          if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-idle'];
          const displayName = currentUser.username || getDisplayName(currentUser.email);
          if (accountBtnLabel) accountBtnLabel.textContent = displayName;
          if (accountAvatarBtn) accountAvatarBtn.textContent = displayName[0]?.toUpperCase() || 'U';
          if (menuUsername) menuUsername.textContent = displayName;
          if (menuEmail) menuEmail.textContent = currentUser.email || '';
          // username chip removed
          if (menuLogin) menuLogin.hidden = true;
          if (menuAccountSettings) menuAccountSettings.hidden = false;
          if (menuSavedPreferences) menuSavedPreferences.hidden = false;
          if (menuNotifications) menuNotifications.hidden = false;
          if (menuLogout) menuLogout.hidden = false;
          hideAuthPage();
        } else {
          authStatus.textContent = translations[currentLang]['auth-status-signed-out'];
          if (logoutBtn) logoutBtn.style.display = 'none';
          if (authEmailInput) authEmailInput.disabled = false;
          if (authPasswordInput) authPasswordInput.disabled = false;
          if (savePreferencesBtn) {
            savePreferencesBtn.disabled = true;
            savePreferencesBtn.classList.add('btn-disabled');
            savePreferencesBtn.title = translations[currentLang]['pref-status-login-required'];
          }
          if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-login-required'];
          if (accountBtnLabel) accountBtnLabel.textContent = translations[currentLang]['nav-login'];
          if (accountAvatarBtn) accountAvatarBtn.textContent = 'U';
          if (menuUsername) menuUsername.textContent = translations[currentLang]['menu-guest-title'];
          if (menuEmail) menuEmail.textContent = translations[currentLang]['menu-guest-subtitle'];
          // username chip removed
          if (menuLogin) menuLogin.hidden = false;
          if (menuAccountSettings) menuAccountSettings.hidden = true;
          if (menuSavedPreferences) menuSavedPreferences.hidden = true;
          if (menuNotifications) menuNotifications.hidden = true;
          if (menuLogout) menuLogout.hidden = true;
          if (isAuthOpen) {
            showAuthPage();
          } else {
            hideAuthPage();
          }
        }
      }

      async function loadCurrentUser() {
        const token = getAuthToken();
        if (!token) {
          currentUser = null;
          renderAuthState();
          return;
        }
        try {
          const resp = await fetch('/api/me', {
            headers: {
              Authorization: `Bearer ${token}`
            }
          });
          if (!resp.ok) {
            setAuthToken(null);
            currentUser = null;
            renderAuthState();
            return;
          }
          const data = await resp.json();
          currentUser = data.user || null;
          renderAuthState();
          await loadPreferences();
        } catch (e) {
          console.error('loadCurrentUser error', e);
        }
      }

      async function loadPreferences() {
        const token = getAuthToken();
        if (!token) return;
        try {
          const resp = await fetch('/api/preferences', {
            headers: {
              Authorization: `Bearer ${token}`
            }
          });
          if (!resp.ok) return;
          const data = await resp.json();
          const pref = data.preferences;
          if (!pref) return;
          if (pref.topic && topicInput) topicInput.value = pref.topic;
          if (pref.region && addressInput) addressInput.value = pref.region;
          if (pref.lang) updateLanguage(pref.lang);
          if (pref.sources && Array.isArray(pref.sources)) {
            const select = document.getElementById('presetSource');
            if (select && pref.sources[0]) {
              select.value = pref.sources[0];
            }
          }
        } catch (e) {
          console.error('loadPreferences error', e);
        }
      }

      function collectPreferences() {
        const presetSource = document.getElementById('presetSource')?.value || '';
        return {
          topic: topicInput?.value?.trim() || null,
          region: addressInput?.value?.trim() || null,
          lang: currentLang,
          sources: presetSource ? [presetSource] : null
        };
      }

      async function savePreferences() {
        const token = getAuthToken();
        if (!token) {
          if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-login-required'];
          return;
        }
        try {
          const payload = collectPreferences();
          const resp = await fetch('/api/preferences', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });
          if (!resp.ok) {
            if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-error'];
            return;
          }
          const savedResp = await fetch('/api/saved-preferences', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`
            },
            body: JSON.stringify(payload)
          });
          if (!savedResp.ok) {
            if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-error'];
            return;
          }
          if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-saved'];
        } catch (e) {
          console.error('savePreferences error', e);
          if (prefStatus) prefStatus.textContent = translations[currentLang]['pref-status-error'];
        }
      }

      // ÂàùÂßãÂåñÔºöË®≠ÁΩÆÈªòË™çË™ûË®Ä
      let initialLang = 'en';
      try {
        const storedLang = window.localStorage.getItem(LANG_KEY);
        if (storedLang === 'en' || storedLang === 'zh') {
          initialLang = storedLang;
        }
      } catch (e) {
        console.error('lang read error', e);
      }
      updateLanguage(initialLang);

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          updateLanguage(btn.dataset.lang);
        });
      });

      if (authForm) {
        authForm.addEventListener('click', async (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          const action = target.getAttribute('data-auth-action');
          if (!action) return;
          const email = authEmailInput?.value?.trim() || '';
          const password = authPasswordInput?.value || '';
          if (!email || !password) {
            authStatus.textContent = translations[currentLang]['auth-error-missing'];
            return;
          }
          const endpoint = action === 'signup' ? '/api/auth/signup' : '/api/auth/login';
          try {
            const resp = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ email, password })
            });
            const data = await resp.json();
            if (!resp.ok) {
              authStatus.textContent = getAuthErrorMessage(data.error);
              return;
            }
            if (data.token) {
              setAuthToken(data.token);
            }
            currentUser = data.user || null;
            isAuthOpen = false;
            closeMenu();
            renderAuthState();
            await loadPreferences();
          } catch (e) {
            console.error('auth error', e);
            authStatus.textContent = translations[currentLang]['auth-status-error'];
          }
        });
      }

      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          setAuthToken(null);
          currentUser = null;
          isAuthOpen = false;
          closeMenu();
          renderAuthState();
        });
      }

      if (accountBtn) {
        accountBtn.addEventListener('click', () => {
          if (isMenuOpen) {
            closeMenu();
          } else {
            openMenu();
          }
        });
      }

      if (menuLogin) {
        menuLogin.addEventListener('click', () => {
          showAuthPage();
          authEmailInput?.focus();
          closeMenu();
        });
      }

      if (menuAccountSettings) {
        menuAccountSettings.addEventListener('click', () => {
          if (!currentUser) return;
          window.location.href = '/account.html';
        });
      }

      if (menuSavedPreferences) {
        menuSavedPreferences.addEventListener('click', () => {
          if (!currentUser) return;
          window.location.href = '/preferences.html';
        });
      }

      if (menuNotifications) {
        menuNotifications.addEventListener('click', () => {
          if (!currentUser) return;
          window.location.href = '/notifications.html';
        });
      }

      if (menuHome) {
        menuHome.addEventListener('click', () => {
          window.location.href = '/';
        });
      }

      if (menuLogout) {
        menuLogout.addEventListener('click', () => {
          setAuthToken(null);
          currentUser = null;
          isAuthOpen = false;
          closeMenu();
          renderAuthState();
        });
      }

      if (authCloseBtn) {
        authCloseBtn.addEventListener('click', () => {
          hideAuthPage();
        });
      }

      document.addEventListener('click', (event) => {
        if (!isMenuOpen) return;
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        if (accountMenu && accountMenu.contains(target)) return;
        if (accountBtn && accountBtn.contains(target)) return;
        closeMenu();
      });

      if (savePreferencesBtn) {
        savePreferencesBtn.addEventListener('click', () => {
          savePreferences();
        });
      }


      loadCurrentUser();

      // Ë®≠ÁΩÆÂú∞ÂùÄËº∏ÂÖ•Ê°ÜÈ´òÂ∫¶ËàátopicËº∏ÂÖ•Ê°Ü‰∏ÄËá¥
      function syncInputHeight() {
        if (topicInput && addressInput) {
          const topicHeight = topicInput.offsetHeight;
          addressInput.style.height = topicHeight + 'px';
        }
      }
      
      // ÂàùÂßãÂåñÊôÇÂêåÊ≠•È´òÂ∫¶
      window.addEventListener('load', syncInputHeight);
      setTimeout(syncInputHeight, 100);
      
      // Áï∂Á™óÂè£Â§ßÂ∞èÊîπËÆäÊôÇÈáçÊñ∞ÂêåÊ≠•
      window.addEventListener('resize', syncInputHeight);

      // ‰ΩçÁΩÆÂÅµÊ∏¨ÂäüËÉΩ
      document.getElementById('detectLocation').addEventListener('click', async () => {
        const btn = document.getElementById('detectLocation');
        
        btn.disabled = true;
        btn.textContent = translations[currentLang]['detecting-location'];
        
        if (!navigator.geolocation) {
          alert(translations[currentLang]['location-error']);
          btn.disabled = false;
          btn.textContent = translations[currentLang]['detect-location'];
          return;
        }
        
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: 10000,
              enableHighAccuracy: false
            });
          });
          
          // ‰ΩøÁî®ÂèçÂêëÂú∞ÁêÜÁ∑®Á¢º API
          const { latitude, longitude } = position.coords;
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=zoom=10&addressdetails=1&accept-language=en`
          );
          const data = await response.json();
          
          if (data && data.address) {
            const address = data.address;
            let locationText = '';
            
            // ÊßãÂª∫Âú∞ÂùÄÂ≠óÁ¨¶‰∏≤
            if (address.city || address.town || address.village) {
              locationText = address.city || address.town || address.village;
            }
            if (address.state) {
              locationText += locationText ? `, ${address.state}` : address.state;
            }
            if (address.country) {
              locationText += locationText ? `, ${address.country}` : address.country;
            }
            
            if (locationText) {
              addressInput.value = locationText;
              btn.textContent = translations[currentLang]['location-success'];
            } else {
              throw new Error('No location data');
            }
          } else {
            throw new Error('No location data');
          }
        } catch (error) {
          console.error('Location detection error:', error);
          // Fallback: IP-based geolocation
          try {
            const ipRes = await fetch("https://ipapi.co/json/");
            if (ipRes.ok) {
              const ipData = await ipRes.json();
              const parts = [];
              if (ipData.city) parts.push(ipData.city);
              if (ipData.region) parts.push(ipData.region);
              if (ipData.country_name) parts.push(ipData.country_name);
              const ipLocation = parts.join(", ");
              if (ipLocation) {
                addressInput.value = ipLocation;
                btn.textContent = translations[currentLang]['location-success'];
              } else {
                alert(translations[currentLang]['location-error']);
                btn.textContent = translations[currentLang]['detect-location'];
              }
            } else {
              alert(translations[currentLang]['location-error']);
              btn.textContent = translations[currentLang]['detect-location'];
            }
          } catch (ipError) {
            console.error('IP-based location error:', ipError);
            alert(translations[currentLang]['location-error']);
            btn.textContent = translations[currentLang]['detect-location'];
          }
        } finally {
          btn.disabled = false;
        }
      });

      // Ë°®ÂñÆÊèê‰∫§
      const form = document.getElementById("interestForm");
      const newsList = document.getElementById("newsList");
      const statusBox = document.getElementById("status");
      const takeawaySection = document.getElementById("takeawaySection");
      const thingsToWatch = document.getElementById("thingsToWatch");
      const takeawayBox = document.getElementById("takeawayBox");
      const aiDisabledNotice = document.getElementById("aiDisabledNotice");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // ËôïÁêÜÂú∞ÂùÄËº∏ÂÖ•
        const address = formData.get('address').trim();
        if (address) {
          // Á∞°ÂñÆËß£ÊûêÂú∞ÂùÄÔºåÊèêÂèñÂüéÂ∏ÇÊàñÂúãÂÆ∂
          const addressParts = address.split(',').map(s => s.trim());
          const region = addressParts[addressParts.length - 1] || addressParts[0] || 'us';
          params.append('region', region);
        } else {
          params.append('region', 'us');
        }
        
        
        // ÂÖ∂‰ªñÂèÉÊï∏
        params.append('topic', formData.get('topic') || 'trending');
        const presetSource = formData.get('presetSource') || '';
        if (presetSource) {
          params.append('presetId', presetSource);
        }
        params.append('lang', currentLang);


        statusBox.textContent = translations[currentLang]["status-loading"];
        statusBox.className = "status loading";
        newsList.innerHTML = "";
        takeawaySection.style.display = "none";
        aiDisabledNotice.style.display = "none";

        try {
          const response = await fetch(`/api/news?${params.toString()}`);
          const payload = await response.json();

          if (!response.ok) {
            throw new Error(payload.error || translations[currentLang]["error-fetch"]);
          }

          const { items, takeaway } = payload;

          if (!items.length) {
            statusBox.textContent = translations[currentLang]["status-no-news"];
            statusBox.className = "status";
            return;
          }

          statusBox.textContent = translations[currentLang]["status-count"].replace("{count}", items.length);
          statusBox.className = "status";

          // ËôïÁêÜ AI Á∏ΩÁµê
          if (takeaway && takeaway.things_to_watch && takeaway.takeaway) {
            // AI ÂäüËÉΩÂèØÁî®ÔºåÈ°ØÁ§∫Á∏ΩÁµê
            if (takeaway.things_to_watch) {
              const thingsList = takeaway.things_to_watch.split('\n').filter(line => line.trim());
              thingsToWatch.innerHTML = `
                <h3>${translations[currentLang]["things-to-watch"]}</h3>
                <ul>
                  ${thingsList.map(item => `<li>${item.replace(/^\d+\.\s*/, '').trim()}</li>`).join('')}
                </ul>
              `;
            }
            if (takeaway.takeaway) {
              takeawayBox.innerHTML = `
                <h3>${translations[currentLang]["takeaway"]}</h3>
                <p>${takeaway.takeaway}</p>
              `;
            }
            takeawaySection.style.display = "block";
            aiDisabledNotice.style.display = "none";
          } else {
            // AI ÂäüËÉΩ‰∏çÂèØÁî®ÔºåÈ°ØÁ§∫ÊèêÁ§∫
            aiDisabledNotice.style.display = "block";
            takeawaySection.style.display = "none";
          }

          // È°ØÁ§∫Êñ∞ËÅûÂàóË°®ÔºàÂè™È°ØÁ§∫Ê®ôÈ°åÂíåÈÄ£ÁµêÔºåÂ≠óÈ´îËºÉÂ∞èÔºâ
          newsList.innerHTML = items
            .map(
              (item) => `
                <article class="news-item">
                  <h3><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></h3>
                  <span class="link-icon">‚Üí</span>
                </article>
              `
            )
            .join("");
        } catch (error) {
          console.error(error);
          statusBox.textContent = error.message;
          statusBox.className = "error";
        }
      });
// ----- Dark mode toggle -----
    function applyTheme(theme) {
      const body = document.body;
      if (theme === 'dark') {
        body.classList.add('dark');
      } else {
        body.classList.remove('dark');
      }
      if (themeToggle) {
        themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }
    }

    function initTheme() {
      let theme = 'light';
      try {
        const stored = window.localStorage.getItem(THEME_KEY);
        if (stored === 'dark' || stored === 'light') {
          theme = stored;
        } else {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            theme = 'dark';
          }
        }
      } catch (e) {
        console.error('theme read error', e);
      }
      applyTheme(theme);
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const current = document.body.classList.contains('dark') ? 'dark' : 'light';
          const next = current === 'dark' ? 'light' : 'dark';
          applyTheme(next);
          try {
            window.localStorage.setItem(THEME_KEY, next);
          } catch (e) {
            console.error('theme save error', e);
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      try {
        initTheme();
      } catch (e) {
        console.error('initTheme error', e);
      }
    });
</script>
  </body>
</html>
