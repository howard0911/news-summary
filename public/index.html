<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Daily Digest</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∞</text></svg>"
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

      :root {
        --bg: #ffffff;
        --bg-secondary: #f8f9fa;
        --text: #1a1a1a;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --border: #e5e7eb;
        --border-light: #f3f4f6;
        --primary: #000000;
        --accent: #6366f1;
        --accent-light: #e0e7ff;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
      }

      /* Dark Mode */
      body.dark {
        --bg: #020617;
        --bg-secondary: #020617;
        --text: #e5e7eb;
        --text-secondary: #9ca3af;
        --text-muted: #6b7280;
        --border: #1f2937;
        --border-light: #111827;
        --primary: #f9fafb;
        --accent: #6366f1;
        --accent-light: #1d253b;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
        font-weight: 400;
        -webkit-font-smoothing: antialiased;
        transition: background 0.25s ease, color 0.25s ease;
      }

      .lang-toggle {
        position: fixed;
        top: 1.5rem;
        right: 1.5rem;
        z-index: 100;
        display: flex;
        gap: 0.5rem;
        background: var(--bg);
        padding: 0.5rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.12);
        align-items: center;
      }

      .lang-btn {
        padding: 0.4rem 0.9rem;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: 999px;
        font-weight: 500;
        font-size: 0.8rem;
        transition: all 0.2s;
      }

      .lang-btn.active {
        background: var(--primary);
        color: var(--bg);
      }

      .lang-btn:hover:not(.active) {
        background: var(--bg-secondary);
        color: var(--text);
      }

      .theme-btn {
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        border: none;
        background: var(--bg-secondary);
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      header {
        text-align: center;
        padding: 4.5rem 1.5rem 2.5rem;
        background: var(--bg);
      }

      header h1 {
        font-size: clamp(2.5rem, 6vw, 3.7rem);
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text);
        letter-spacing: -0.02em;
      }

      header p {
        font-size: 1.1rem;
        color: var(--text-secondary);
        font-weight: 400;
        max-width: 620px;
        margin: 0 auto;
      }

      main {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 1.5rem 3rem;
      }

      .card {
        background: var(--bg);
        border-radius: 20px;
        padding: 1.75rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.75rem;
        color: var(--text);
        font-size: 0.95rem;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        background: var(--bg);
        color: var(--text);
        font-size: 0.95rem;
        margin-bottom: 1rem;
        transition: all 0.2s;
        font-family: inherit;
        font-weight: 400;
      }

      textarea {
        min-height: 44px;
        resize: vertical;
        line-height: 1.5;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
      }

      input::placeholder,
      textarea::placeholder {
        color: var(--text-muted);
      }

      button {
        width: 100%;
        padding: 0.9rem 1.5rem;
        border-radius: 12px;
        border: none;
        font-size: 0.95rem;
        font-weight: 600;
        background: var(--primary);
        color: var(--bg);
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }

      button:hover {
        background: #111827;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
      }

      button:active {
        transform: translateY(0);
        box-shadow: none;
      }

      .address-input-wrapper {
        display: flex;
        gap: 0.75rem;
        align-items: stretch;
        margin-bottom: 1rem;
        flex-direction: row;
      }

      .address-input-wrapper textarea {
        flex: 1;
        margin-bottom: 0;
        min-height: auto;
        height: auto;
        line-height: 1.5;
        padding: 0.75rem 1rem;
        resize: none;
        overflow-y: auto;
        order: 2;
        box-sizing: border-box;
      }

      .helper-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: -0.4rem;
        margin-bottom: 1rem;
      }

      .location-detect-btn {
        padding: 0.75rem 0.875rem;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        background: var(--bg-secondary);
        color: var(--text);
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        transition: all 0.2s;
        font-family: inherit;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
        flex-shrink: 0;
        align-self: stretch;
        order: 1;
        min-width: auto;
        width: auto !important;
        max-width: fit-content;
        box-sizing: border-box;
        height: 100%;
      }

      .location-detect-btn:hover {
        background: var(--border);
        border-color: var(--primary);
      }

      .location-detect-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .takeaway-section {
        background: var(--bg-secondary);
        padding: 1.75rem;
        border-radius: 18px;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
      }

      .takeaway-section h2 {
        font-size: 1.35rem;
        margin-bottom: 1.25rem;
        font-weight: 600;
        color: var(--text);
      }

      .things-to-watch {
        margin-bottom: 1.25rem;
      }

      .things-to-watch h3 {
        font-size: 0.95rem;
        margin-bottom: 0.8rem;
        color: var(--text);
        font-weight: 500;
      }

      .things-to-watch ul {
        list-style: none;
        padding-left: 0;
      }

      .things-to-watch li {
        padding: 0.6rem 0.85rem;
        margin-bottom: 0.45rem;
        background: var(--bg);
        border-radius: 10px;
        border-left: 3px solid var(--accent);
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .takeaway-box {
        background: var(--bg);
        padding: 1.25rem;
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .takeaway-box h3 {
        font-size: 0.95rem;
        margin-bottom: 0.6rem;
        font-weight: 600;
        color: var(--text);
      }

      .takeaway-box p {
        font-size: 0.95rem;
        line-height: 1.7;
        color: var(--text);
      }

      .ai-disabled {
        background: var(--accent-light);
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 1rem 1.5rem;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 0.85rem;
      }

      .status {
        text-align: center;
        padding: 1.25rem;
        color: var(--text-secondary);
        font-size: 0.95rem;
      }

      .error {
        color: var(--error);
        background: #fef2f2;
        padding: 1.25rem;
        border-radius: 12px;
        border: 1px solid #fecaca;
        text-align: center;
        font-size: 0.9rem;
      }

      /* Skeleton loader */
      .news-skeleton {
        display: grid;
        gap: 0.75rem;
      }

      .skeleton-item {
        border-radius: 12px;
        padding: 1rem 1.25rem;
        border: 1px solid var(--border);
        background: var(--bg-secondary);
        position: relative;
        overflow: hidden;
      }

      .skeleton-line {
        height: 0.85rem;
        border-radius: 999px;
        background: var(--border-light);
        margin-bottom: 0.5rem;
        width: 80%;
      }

      .skeleton-line.short {
        width: 50%;
      }

      .skeleton-item::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transform: translateX(-100%);
        animation: shimmer 1.6s infinite;
      }

      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }

      .news-list {
        display: grid;
        gap: 0.75rem;
      }

      .news-item {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.9rem 1.25rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .news-item:hover {
        background: var(--bg-secondary);
        border-color: var(--primary);
        transform: translateX(2px);
      }

      .news-item h3 {
        font-size: 0.9rem;
        font-weight: 500;
        margin: 0;
        flex: 1;
        line-height: 1.5;
        color: var(--text);
      }

      .news-item a {
        color: var(--text);
        text-decoration: none;
        transition: color 0.2s;
      }

      .news-item a:hover {
        color: var(--accent);
      }

      .link-icon {
        color: var(--text-muted);
        font-size: 1rem;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .news-item:hover .link-icon {
        color: var(--primary);
        transform: translateX(2px);
      }

      /* Analytics */
      .analytics-card {
        margin-top: 0.5rem;
      }

      .chart-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.55rem;
      }

      .chart-label {
        flex: 0 0 140px;
        font-size: 0.8rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .chart-bar-wrapper {
        flex: 1;
        background: var(--bg-secondary);
        border-radius: 999px;
        overflow: hidden;
        height: 0.6rem;
      }

      .chart-bar {
        height: 100%;
        background: var(--accent);
        border-radius: 999px;
      }

      .chart-value {
        font-size: 0.75rem;
        color: var(--text-muted);
        min-width: 1.5rem;
        text-align: right;
      }

      @media (max-width: 768px) {
        .lang-toggle {
          top: 1rem;
          right: 1rem;
        }

        header {
          padding: 4rem 1rem 2.5rem;
        }

        .card {
          padding: 1.5rem;
        }

        .chart-label {
          flex-basis: 100px;
        }

        .news-item {
          flex-direction: column;
          align-items: flex-start;
        }

        .news-item h3 {
          margin-bottom: 0.4rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="lang-toggle">
      <button class="lang-btn active" data-lang="en">English</button>
      <button class="lang-btn" data-lang="zh">‰∏≠Êñá</button>
      <button class="theme-btn" id="themeToggle">üåô</button>
    </div>

    <header>
      <h1 data-i18n="title">üì∞ Daily Digest</h1>
      <p data-i18n="subtitle">Get your personalized news summary in seconds</p>
    </header>

    <main>
      <!-- Form card -->
      <section class="card">
        <form id="interestForm">
          <div>
            <label for="topic" data-i18n="topic-label">
              What news topics interest you?
            </label>
            <input
              id="topic"
              name="topic"
              data-i18n-placeholder="topic-placeholder"
              placeholder="e.g., Finance, Tech, Lifestyle, AI"
              required
            />
          </div>

          <div>
            <label for="address" data-i18n="address-label">
              Location (City, State/Province, Country)
            </label>
            <div class="address-input-wrapper">
              <button
                type="button"
                class="location-detect-btn"
                id="detectLocation"
                data-i18n="detect-location"
              >
                üìç Detect My Location
              </button>
              <textarea
                id="address"
                name="address"
                data-i18n-placeholder="address-placeholder"
                placeholder="e.g., New York, USA, Taiwan, or London"
                rows="1"
                required
              ></textarea>
            </div>
            <p class="helper-text" data-i18n="address-helper">
              Enter your location or click to detect automatically
            </p>
            <p
              id="regionBadge"
              style="font-size: .8rem; color: var(--text-muted); margin-top: -0.3rem; display: none;"
            ></p>
          </div>

          <div>
            <label for="customUrl" data-i18n="url-label">
              Custom RSS / News URL (Optional, article URL is also OK)
            </label>
            <input
              id="customUrl"
              name="customUrl"
              data-i18n-placeholder="url-placeholder"
              placeholder="e.g., https://example.com/rss or https://news-site/article"
            />
          </div>

          <button type="submit" data-i18n="submit-btn">
            Generate Daily Digest
          </button>
        </form>

        <p
          class="status"
          id="helper"
          data-i18n="helper-text"
        >
          Fetching latest news from the past 24 hours...
        </p>
      </section>

      <!-- AI unavailable notice -->
      <div
        id="aiDisabledNotice"
        class="ai-disabled"
        style="display: none"
        data-i18n="ai-disabled"
      >
        AI summarization is currently unavailable. News articles are displayed
        without AI-generated summaries.
      </div>

      <!-- Takeaway section -->
      <section
        id="takeawaySection"
        class="card takeaway-section"
        style="display: none"
      >
        <h2 data-i18n="takeaway-title">Today's Highlights</h2>
        <div class="things-to-watch" id="thingsToWatch"></div>
        <div class="takeaway-box" id="takeawayBox"></div>
      </section>

      <!-- News list -->
      <section class="card">
        <div
          id="status"
          class="status"
          data-i18n="status-default"
        >
          Please submit the form to get your daily digest.
        </div>
        <div class="news-list" id="newsList"></div>
      </section>

      <!-- Simple Analytics -->
      <section
        class="card analytics-card"
        id="analyticsCard"
        style="display: none"
      >
        <h2
          style="font-size: 1.1rem; margin-bottom: 1rem"
          data-i18n="analytics-title"
        >
          News Analytics
        </h2>
        <div id="sourceChart"></div>
      </section>
    </main>

    <script>
      // ------- i18n -------
      let currentLang = 'en';
      let detectedRegionCode = null; // ISO-3166 alpha2 (from geolocation)
      let regionConfigs = []; // from /api/regions

      const translations = {
        zh: {
          title: 'üì∞ ÊØèÊó•ÊëòË¶Å',
          subtitle: 'ÂπæÁßíÂÖßÁç≤ÂèñÊÇ®ÁöÑÂÄãÊÄßÂåñÊñ∞ËÅûÊëòË¶Å',
          'topic-label': 'ÊÇ®Â∞çÂì™‰∫õÊñ∞ËÅû‰∏ªÈ°åÊÑüËààË∂£ÔºüÔºàÂèØËº∏ÂÖ•‰∏≠ÊñáÊàñËã±ÊñáÔºâ',
          'topic-placeholder': '‰æãÂ¶ÇÔºöÂè∞ËÇ°„ÄÅÁæéËÇ°„ÄÅAI„ÄÅÊàøÂÉπ„ÄÅcrypto',
          'address-label': '‰ΩçÁΩÆÔºàÂüéÂ∏Ç„ÄÅÂ∑û/ÁúÅ„ÄÅÂúãÂÆ∂Ôºâ',
          'address-placeholder': '‰æãÂ¶ÇÔºöÂè∞ÂåóÔºåÂè∞ÁÅ£ÔºõÊù±‰∫¨ÔºåÊó•Êú¨ÔºõNew York, USA',
          'address-helper': 'Ë´ãËº∏ÂÖ•‰ΩçÁΩÆÊàñÈªûÊìäËá™ÂãïÂÅµÊ∏¨ÔºàÊúÉÁî®‰æÜÈÅ∏ÊìáÊñ∞ËÅûÂú∞ÂçÄÔºâ',
          'detect-location': 'üìç ÂÅµÊ∏¨ÊàëÁöÑ‰ΩçÁΩÆ',
          'detecting-location': 'Ê≠£Âú®ÂÅµÊ∏¨‰ΩçÁΩÆ...',
          'location-error': 'ÁÑ°Ê≥ïÂÅµÊ∏¨‰ΩçÁΩÆÔºåË´ãÊâãÂãïËº∏ÂÖ•„ÄÇ',
          'location-success': '‰ΩçÁΩÆÂ∑≤ÂÅµÊ∏¨ÔºÅ',
          'url-label': 'Ëá™Ë®Ç RSS / Êñ∞ËÅûÁ∂≤ÂùÄÔºàÈÅ∏Â°´ÔºåÂèØÁõ¥Êé•Ë≤ºÊñ∞ËÅûÈ†ÅÁ∂≤ÂùÄÔºâ',
          'url-placeholder': '‰æãÂ¶ÇÔºöhttps://example.com/rss Êàñ https://news-site/article',
          'submit-btn': 'ÁîüÊàêÊØèÊó•ÊëòË¶Å',
          'helper-text': 'Ê≠£Âú®Áç≤ÂèñÈÅéÂéª24Â∞èÊôÇÁöÑÊúÄÊñ∞Êñ∞ËÅû...',
          'status-default': 'Ë´ãÊèê‰∫§Ë°®ÂñÆ‰ª•Áç≤ÂèñÊÇ®ÁöÑÊØèÊó•ÊëòË¶Å„ÄÇ',
          'status-loading': 'Ê≠£Âú®Áç≤ÂèñÊúÄÊñ∞Êñ∞ËÅû‚Ä¶',
          'status-no-news': 'ÁõÆÂâçÊ≤íÊúâÁ¨¶ÂêàÁöÑÊñ∞ËÅûÔºåÊèõÂÄãÈóúÈçµÂ≠óË©¶Ë©¶Ôºü',
          'status-count': 'ÊâæÂà∞ {count} ÂâáÁõ∏ÈóúÊñ∞ËÅû',
          'takeaway-title': '‰ªäÊó•ÈáçÈªû',
          'things-to-watch': '‰ªäÂ§©ÈúÄË¶ÅÊ≥®ÊÑèÁöÑ‰∫ãÊÉÖ',
          takeaway: 'Take Away',
          'error-fetch': 'ÁÑ°Ê≥ïÂèñÂæóÊñ∞ËÅû',
          'ai-disabled':
            'AI ÊëòË¶ÅÂäüËÉΩÁõÆÂâç‰∏çÂèØÁî®„ÄÇÊñ∞ËÅûÊñáÁ´†Â∞áÂú®Ê≤íÊúâ AI ÁîüÊàêÊëòË¶ÅÁöÑÊÉÖÊ≥Å‰∏ãÈ°ØÁ§∫„ÄÇ',
          'analytics-title': 'Êñ∞ËÅû‰æÜÊ∫êÂàÜÊûê',
        },
        en: {
          title: 'üì∞ Daily Digest',
          subtitle: 'Get your personalized news summary in seconds',
          'topic-label': 'What news topics interest you?',
          'topic-placeholder': 'e.g., US stocks, AI, housing, crypto',
          'address-label': 'Location (City, State/Province, Country)',
          'address-placeholder':
            'e.g., New York, USA; Taipei, Taiwan; Tokyo, Japan',
          'address-helper':
            'Enter your location or click to detect automatically (used for news region)',
          'detect-location': 'üìç Detect My Location',
          'detecting-location': 'Detecting location...',
          'location-error':
            'Unable to detect location. Please enter manually.',
          'location-success': 'Location detected!',
          'url-label':
            'Custom RSS / News URL (optional, article URL is also OK)',
          'url-placeholder':
            'e.g., https://example.com/rss or https://news-site/article',
          'submit-btn': 'Generate Daily Digest',
          'helper-text':
            'Fetching latest news from the past 24 hours...',
          'status-default':
            'Please submit the form to get your daily digest.',
          'status-loading': 'Fetching latest news‚Ä¶',
          'status-no-news':
            'No matching news found. Try different keywords?',
          'status-count': 'Found {count} relevant news articles',
          'takeaway-title': "Today's Highlights",
          'things-to-watch': 'Things to Watch Today',
          takeaway: 'Take Away',
          'error-fetch': 'Failed to fetch news',
          'ai-disabled':
            'AI summarization is currently unavailable. News articles are displayed without AI-generated summaries.',
          'analytics-title': 'News Analytics',
        },
      };

      function updateLanguage(lang) {
        currentLang = lang;
        document
          .querySelectorAll('[data-i18n]')
          .forEach((el) => {
            const key = el.getAttribute('data-i18n');
            if (translations[lang][key]) {
              el.textContent = translations[lang][key];
            }
          });

        document
          .querySelectorAll('[data-i18n-placeholder]')
          .forEach((el) => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (translations[lang][key]) {
              el.placeholder = translations[lang][key];
            }
          });

        document.querySelectorAll('.lang-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.lang === lang);
        });
      }

      document.querySelectorAll('.lang-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          updateLanguage(btn.dataset.lang);
        });
      });

      // ---- Theme toggle (dark / light) ----
      const themeToggle = document.getElementById('themeToggle');

      function applyTheme(theme) {
        document.body.classList.toggle('dark', theme === 'dark');
        themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        try {
          localStorage.setItem('theme', theme);
        } catch (e) {}
      }

      const savedTheme = (() => {
        try {
          return localStorage.getItem('theme');
        } catch (e) {
          return null;
        }
      })();

      applyTheme(savedTheme === 'dark' ? 'dark' : 'light');

      themeToggle.addEventListener('click', () => {
        const next = document.body.classList.contains('dark')
          ? 'light'
          : 'dark';
        applyTheme(next);
      });

      // initialize language
      updateLanguage('en');

      // sync address textarea height with topic input
      const addressInput = document.getElementById('address');
      const topicInput = document.getElementById('topic');

      function syncInputHeight() {
        if (topicInput && addressInput) {
          const topicHeight = topicInput.offsetHeight;
          addressInput.style.height = topicHeight + 'px';
        }
      }

      window.addEventListener('load', syncInputHeight);
      setTimeout(syncInputHeight, 100);
      window.addEventListener('resize', syncInputHeight);

      // load regions from backend
      async function loadRegions() {
        try {
          const resp = await fetch('/api/regions');
          const data = await resp.json();
          regionConfigs = data.regions || [];
        } catch (e) {
          console.warn('Failed to load regions', e);
        }
      }
      loadRegions();

      // ---- Location detection ----
      document
        .getElementById('detectLocation')
        .addEventListener('click', async () => {
          const btn = document.getElementById('detectLocation');

          btn.disabled = true;
          btn.textContent = translations[currentLang]['detecting-location'];

          if (!navigator.geolocation) {
            alert(translations[currentLang]['location-error']);
            btn.disabled = false;
            btn.textContent =
              translations[currentLang]['detect-location'];
            return;
          }

          try {
            const position = await new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(
                resolve,
                reject,
                {
                  timeout: 10000,
                  enableHighAccuracy: false,
                }
              );
            });

            const { latitude, longitude } = position.coords;
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=4&addressdetails=1`
            );
            const data = await response.json();

            if (data && data.address) {
              const address = data.address;
              let locationText = '';

              if (
                address.city ||
                address.town ||
                address.village
              ) {
                locationText =
                  address.city || address.town || address.village;
              }
              if (address.state) {
                locationText += locationText
                  ? `, ${address.state}`
                  : address.state;
              }
              if (address.country) {
                locationText += locationText
                  ? `, ${address.country}`
                  : address.country;
              }

              let cc = (address.country_code || '').toLowerCase();
              if (cc === 'gb') cc = 'uk';
              detectedRegionCode = cc || null;

              if (locationText) {
                addressInput.value = locationText;
                btn.textContent =
                  translations[currentLang]['location-success'];
              } else {
                throw new Error('No location data');
              }
            } else {
              throw new Error('No location data');
            }
          } catch (error) {
            console.error('Location detection error:', error);
            alert(translations[currentLang]['location-error']);
            btn.textContent =
              translations[currentLang]['detect-location'];
          } finally {
            btn.disabled = false;
          }
        });

      // ---- Region inference ----
      function inferRegionFromAddress(address) {
        // 1. geolocation ISO code
        if (detectedRegionCode) {
          return detectedRegionCode;
        }

        if (!address) return 'us';

        const parts = address
          .split(',')
          .map((s) => s.trim().toLowerCase());

        // 1.5 ‰∏≠Êñá/Âà•ÂêçÊò†Â∞Ñ
        const zhRegionMap = [
          { code: 'tw', keywords: ['Âè∞ÁÅ£', 'Ëá∫ÁÅ£', 'Âè∞Êπæ', 'taiwan'] },
          { code: 'hk', keywords: ['È¶ôÊ∏Ø', 'hong kong'] },
          { code: 'jp', keywords: ['Êó•Êú¨', 'japan', 'tokyo'] },
          {
            code: 'us',
            keywords: ['ÁæéÂúã', 'ÁæéÂõΩ', 'usa', 'u.s.', 'united states'],
          },
          {
            code: 'uk',
            keywords: ['Ëã±Âúã', 'Ëã±ÂõΩ', 'uk', 'united kingdom', 'england'],
          },
          { code: 'sg', keywords: ['Êñ∞Âä†Âù°', 'singapore'] },
        ];

        for (const p of parts) {
          for (const m of zhRegionMap) {
            if (m.keywords.some((kw) => p.includes(kw))) {
              return m.code;
            }
          }
        }

        // 2. two-letter region code in address
        for (const p of parts) {
          if (p.length === 2) {
            const hit = regionConfigs.find(
              (r) => r.code.toLowerCase() === p
            );
            if (hit) return hit.code.toLowerCase();
          }
        }

        // 3. fuzzy match by english name
        for (const p of parts) {
          const hit = regionConfigs.find((r) =>
            r.name.toLowerCase().includes(p)
          );
          if (hit) return hit.code.toLowerCase();
        }

        return 'us';
      }

      // ---- Form submit ----
      const form = document.getElementById('interestForm');
      const newsList = document.getElementById('newsList');
      const statusBox = document.getElementById('status');
      const takeawaySection = document.getElementById(
        'takeawaySection'
      );
      const thingsToWatch = document.getElementById('thingsToWatch');
      const takeawayBox = document.getElementById('takeawayBox');
      const aiDisabledNotice =
        document.getElementById('aiDisabledNotice');
      const analyticsCard = document.getElementById('analyticsCard');
      const sourceChart = document.getElementById('sourceChart');
      const regionBadge = document.getElementById('regionBadge');

      function renderAnalytics(items) {
        if (!analyticsCard || !sourceChart) return;

        if (!items || !items.length) {
          analyticsCard.style.display = 'none';
          return;
        }

        const counts = {};
        items.forEach((item) => {
          try {
            const url = new URL(item.link);
            let host = url.hostname
              .toLowerCase()
              .replace(/^www\./, '');
            counts[host] = (counts[host] || 0) + 1;
          } catch (e) {
            // ignore
          }
        });

        const entries = Object.entries(counts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        if (!entries.length) {
          analyticsCard.style.display = 'none';
          return;
        }

        const max = entries[0][1] || 1;

        sourceChart.innerHTML = entries
          .map(
            ([host, count]) => `
          <div class="chart-row">
            <span class="chart-label">${host}</span>
            <div class="chart-bar-wrapper">
              <div class="chart-bar" style="width:${
                (count / max) * 100
              }%"></div>
            </div>
            <span class="chart-value">${count}</span>
          </div>
        `
          )
          .join('');

        analyticsCard.style.display = 'block';
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const params = new URLSearchParams();

        const address = (formData.get('address') || '').trim();
        const region = inferRegionFromAddress(address);
        params.append('region', region || 'us');

        params.append(
          'topic',
          formData.get('topic') || 'trending'
        );
        params.append(
          'customUrl',
          formData.get('customUrl') || ''
        );
        params.append('lang', currentLang);

        // È°ØÁ§∫ region badge
        if (regionBadge) {
          const cfg = regionConfigs.find(
            (r) => r.code.toLowerCase() === (region || 'us')
          );
          if (cfg) {
            regionBadge.textContent = `Region: ${cfg.name} (${cfg.code.toUpperCase()})`;
            regionBadge.style.display = 'block';
          } else {
            regionBadge.textContent = `Region: ${region.toUpperCase()}`;
            regionBadge.style.display = 'block';
          }
        }

        // status & skeleton
        statusBox.textContent =
          translations[currentLang]['status-loading'];
        statusBox.className = 'status loading';

        newsList.innerHTML = `
          <div class="news-skeleton">
            ${[1, 2, 3]
              .map(
                () => `
              <div class="skeleton-item">
                <div class="skeleton-line"></div>
                <div class="skeleton-line short"></div>
              </div>
            `
              )
              .join('')}
          </div>
        `;

        takeawaySection.style.display = 'none';
        aiDisabledNotice.style.display = 'none';
        analyticsCard.style.display = 'none';
        sourceChart.innerHTML = '';

        try {
          const response = await fetch(
            `/api/news?${params.toString()}`
          );
          const payload = await response.json();

          if (!response.ok) {
            throw new Error(
              payload.error ||
                translations[currentLang]['error-fetch']
            );
          }

          const { items, takeaway, ai_error } = payload;

          if (!items || !items.length) {
            newsList.innerHTML = '';
            statusBox.textContent =
              translations[currentLang]['status-no-news'];
            statusBox.className = 'status';
            return;
          }

          statusBox.textContent =
            translations[currentLang]['status-count'].replace(
              '{count}',
              items.length
            );
          statusBox.className = 'status';

          // AI summary (bilingual)
          if (ai_error) {
            aiDisabledNotice.textContent = ai_error;
            aiDisabledNotice.style.display = 'block';
            takeawaySection.style.display = 'none';
          } else if (
            takeaway &&
            takeaway[currentLang]
          ) {
            const localeTakeaway = takeaway[currentLang];

            if (localeTakeaway.things_to_watch) {
              const thingsList = localeTakeaway.things_to_watch
                .split('\n')
                .filter((line) => line.trim())
                .map((line) =>
                  line.replace(/^\d+\.\s*/, '').trim()
                );

              thingsToWatch.innerHTML = `
                <h3>${translations[currentLang]['things-to-watch']}</h3>
                <ul>
                  ${thingsList
                    .map((item) => `<li>${item}</li>`)
                    .join('')}
                </ul>
              `;
            } else {
              thingsToWatch.innerHTML = '';
            }

            if (localeTakeaway.takeaway) {
              takeawayBox.innerHTML = `
                <h3>${translations[currentLang]['takeaway']}</h3>
                <p>${localeTakeaway.takeaway}</p>
              `;
            } else {
              takeawayBox.innerHTML = '';
            }

            takeawaySection.style.display = 'block';
            aiDisabledNotice.style.display = 'none';
          } else {
            aiDisabledNotice.style.display = 'block';
            takeawaySection.style.display = 'none';
          }

          // news list
          newsList.innerHTML = items
            .map(
              (item) => `
              <article class="news-item">
                <h3>
                  <a href="${item.link}" target="_blank" rel="noopener">
                    ${item.title}
                  </a>
                </h3>
                <span class="link-icon">‚Üí</span>
              </article>
            `
            )
            .join('');

          // analytics
          renderAnalytics(items);
        } catch (error) {
          console.error(error);
          newsList.innerHTML = '';
          statusBox.textContent = error.message;
          statusBox.className = 'error';
        }
      });
    </script>
  </body>
</html>
